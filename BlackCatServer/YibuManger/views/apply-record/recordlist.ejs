
<div class="main" ng-controller="recordlist">
    <div class="main-inner">
        <div class="container">
            <div class="row">
                <div class="span12">
                    <div class="widget-header">
                        <i class="icon-th-large"></i>
                        <h3>申请列表</h3>
                        <div style="float: right ; padding-right: 10px" >
                            <!--
                            <div style="float: left;  padding-right: 10px">
                                <a href="/admin/manage/editActivty"  class="btn  btn-success">添加<i class="btn-icon-only icon-plus " style="float: none"> </i></a>
                            </div>
                            -->
                            <div style="float: right ; padding-right: 10px">
                                <% include ../public/searchBox %>
                            </div>
                        </div>

                    </div> <!-- /widget-header -->
                    <div class="widget-content">
                        <div class="box">
                            <div class="box-body table-responsive no-padding">
                                <table class="table table-hover">
                                    <tr>
                                        <th> 姓名 </th>
                                        <th> 联系电话</th>
                                        <th> 注册方式</th>
                                        <th> 报名状态</th>
                                        <th> 处理状态</th>
                                        <th> 班级类型</th>
                                        <th> Y码</th>
                                        <th>所属驾校</th>
                                        <th>时间</th>
                                        <th>支付方式</th>
                                        <th>支付状态</th>
                                        <th class="td-actions"> 操作</th>
                                    </tr>
                                    <tr class="datalist" ng-repeat="content in data">
                                        <td >
                                            <a href="#" >
                                                <span>{{content.name}}</span> </a>
                                        </td>
                                        <td >
                                            <span>{{content.mobile}}</span>
                                        </td>
                                        <td  ng-switch="content.source">
                                            <span  ng-switch-when="0">app</span>
                                            <span  ng-switch-when="1">后台添加</span>
                                            <span  ng-switch-when="2">微信报名 </span>
                                        </td>
                                        <td ng-switch="content.applystate">
                                            <span  ng-switch-when="0">未报名</span>
                                                <span  ng-switch-when="1">申请中</span>
                                            <span  ng-switch-when="2">报名成功</span>
                                        </td>
                                        <td  ng-switch="content.applyinfo.handelstate">
                                            <span ng-switch-when="0">未处理</span>
                                            <span ng-switch-when="1">处理中</span>
                                            <span ng-switch-when="2">处理成功</span>
                                        </td>
                                        <td >
                                            <span>{{content.applyclasstypeinfo.name}}</span>
                                        </td>
                                        <td >
                                            <span>{{content.referrerfcode}}</span>
                                        </td>
                                        <td >
                                            <span>{{content.applyschoolinfo.name}}</span>
                                        </td>
                                        <td >
                                            <span>{{content.applyinfo.applytime|date:'yyyy-MM-dd HH:mm:ss'}} </span>
                                        </td>
                                        <td ng-switch="content.paytype">

                                            <span  ng-switch-when="1">线下支付</span>
                                            <span  ng-switch-when="2">线上支付</span>
                                        </td>
                                        <td ng-switch="content.paytypestatus">
                                            <span  ng-switch-when="0">未支付</span>
                                            <span  ng-switch-when="20">支付成功</span>
                                            <span  ng-switch-when="30">支付失败</span>
                                        </td>


                                        <td class="td-actions">
                                            <a  id="editapplyinfo" ng-disabled="content.applystate!=1"
                                                ng-click="content.applystate!=1 ||editApplyinfo(content._id,content.name)"
                                               class="btn btn-small btn-success" ><i class="btn-icon-only icon-edit"> </i></a>
                                            <!--<a href="#"-->
                                               <!--class="btn btn-small btn-danger" ><i class="btn-icon-only icon-remove-circle "> </i></a>-->
                                        </td>


                                    </tr>
                                </table>
                            </div><!-- /.box-body -->

                        </div><!-- /.box -->
                        <% include ../public/tableFooter %>
                    </div>
                    <div id="editpage" class="widget-content"  style="display: none">
                        <div class="control-group">
                            <div class="alert">
                                姓名： <strong>  {{formData.name}}</strong>
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                报名教练： <strong>  {{formData.applycoachinfo.name}}</strong>
                                </div>
                            </div>
                        <div class="control-group">
                            <div class="alert">
                                报名驾校： <strong>  {{formData.applyschoolinfo.name}}</strong>
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                报名班级： <strong>  {{formData.applyclasstypeinfo.name}}</strong>
                            </div>
                        </div>

                        <div class="control-group">
                            <div class="alert">
                                报名时间： <strong>  {{formData.applyinfo.applytime}}</strong>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="alert-info">
                                报名状态：    <select style="margin-top: 10px"  ng-disabled="formData.applystate==0" class="span2" id="applystate" ng-model="formData.applystate" >
                                    <option value=0>未报名</option>
                                    <option value=1>报名中</option>
                                    <option value=2>报名成功</option>
                                </select>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="alert-info text-center">
                                处理状态：    <select style="margin-top: 10px" ng-disabled="formData.applystate==0" class="span2" id="handelstate" ng-model="formData.applyinfo.handelstate" >
                                    <option value=0>未处理</option>
                                    <option value=1>处理中</option>
                                    <option value=2>处理成功</option>
                                </select>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="alert-info text-center">
                                处理信息：   <textarea  style="margin-top: 10px"   id="superiorservice"
                                                    rows="3" ng-model="formData.applyinfo.handelmessage" placeholder=""></textarea>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary" ng-disabled="formData.applystate==0"
                                ng-click="auditestudent()">处理</button>
                </div>
            </div>

        </div>
        <!-- /row -->
    </div>
    <!-- /container -->
</div>
<!-- /main-inner -->
</div>


<script>
    ybxcApp.controller("recordlist",function($scope,$http){
        $scope.formData = {};
        //获取文档列表信息
        initPagination($scope,$http,"<%=searchKey%>","/admin/manage/getapplyschoolinfo?schoolid=<%=schoolid%>");
        $scope.editApplyinfo=function(userid,name){
            $scope.formData={};
            var   userdata;
            for(var i=0;i<$scope.data.length;i++){
                if(userid==$scope.data[i]._id){
                    userdata=$scope.data[i];
                    break;
                }
            }
            if(userdata===undefined){
                layer.msg('没有找到用户信息', {
                    icon: 2,
                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                });
                return;
            }
            $scope.formData=userdata;
            $scope.formData.applystate= $scope.formData.applystate.toString();
            $scope.formData.applyinfo.handelstate= $scope.formData.applyinfo.handelstate.toString();
            layer.open({
                type: 1,
                title: '审核用户--'+name,
                maxmin: true,
                shadeClose: true, //点击遮罩关闭层
                // area : ['800px' , '520px'],
                content:$("#editpage")
            });
        };
        $scope.auditestudent=function(){

            if($scope.formData._id===undefined){
                layer.msg('没有找到用户信息', {
                    icon: 2,
                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                })
                return;
            };
                console.log($scope.formData);
                $http.post("/admin/manage/auditstudentapplyinfo",{
                    userid:$scope.formData._id,
                    applystate:$scope.formData.applystate,
                    handelstate:$scope.formData.applyinfo.handelstate,
                    handelmessage:$scope.formData.applyinfo.handelmessage
                }).success(function(response){
                    if (response.type==0){
                        layer.msg(response.msg, {
                            icon: 2,
                            time: 5000 //2秒关闭（如果不配置，默认是3秒）
                        });
                    }else{
                        layer.msg("审核成功", {
                            icon: 1,
                            time: 5000 //2秒关闭（如果不配置，默认是3秒）
                        });
                        window.location.href="/admin//manage/recordlist";
                    }
                })

            }


    });
</script>